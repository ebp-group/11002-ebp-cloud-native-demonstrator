<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, height=device-height" />
    <title>Cloud-Native Geospatial Demonstrator</title>
    <script type="module" src="../shared/index.ts"></script>
    <script type="module" src="./main.ts"></script>
  </head>
  <body>
    <div class="container-fluid h-100">
      <div class="row flex-column flex-md-row h-100">
        <div id="map-container" class="col-12 col-md-6 p-0">
          <div id="map"></div>
        </div>
        <div id="text-container" class="col-12 col-md-6 p-4 d-flex flex-column">
          <a href="%BASE_URL%">&leftarrow;Back to start</a>
          <h1 class="display-1">COGTIFF</h1>

          <div class="alert alert-info">
            <div>
              <b>Elevation at mouseclick:</b>
              <pre><code id="clickresult">none</code></pre>
            </div>
            <p class="d-flex gap-1">
              <button id="clearResults" class="btn btn-primary">Clear</button>
              <button id="toggleRaster" class="btn btn-primary">Toggle raster overlay</button>
            </p>
          </div>

          <div class="overflow-auto">
            <h2 class="display-6">General</h2>
            <ul>
              <li>
                Datasource:
                <a href="https://www.swisstopo.admin.ch/de/hoehenmodell-swissaltiregio" target="_blank">swissALTIRegio</a>
              </li>
              <li>
                Additional library needed:
                <a href="https://www.npmjs.com/package/@geomatico/maplibre-cog-protocol?activeTab=readme" target="_blank">
                  @geomatico/maplibre-cog-protocol
                </a>
              </li>
              <li>Datafile is roughly 4GB, see network tab to see the rangerequests in action.</li>
            </ul>

            <hr />
            <h2 class="display-6">Things to note</h2>
            <p>
              MapLibre does not support COGTIFF natively. Therefore, we need to use an additional protocol handler to read the data.
              Additionally, since Maplibre, or rather the protocol handler, does not support CRSs other than
              <code>EPSG:3857</code>
              and on-the-fly reprojections is not natively available in the protocol handler, we need to reproject the data beforehand.
            </p>
            <p>
              Reprojecting the data can be done using <a href="https://gdal.org/en/stable/" target="_blank"><code>GDAL</code></a
              >.
            </p>
            <pre><code class="language-bash"># Reproject from EPSG:2056 to EPSG:3857; note the compression to create a COG; allow BIGTIFF if needed
gdalwarp -s_srs EPSG:2056 -t_srs EPSG:3857 input.tif output_3857.tif -of COG -co COMPRESS=LZW -co BIGTIFF=YES</code></pre>
            <p>
              Because we're using maplibre's
              <a href="https://maplibre.org/maplibre-gl-js/docs/examples/3d-terrain/" target="_blank">3D Terrain</a>, we need to encode our
              raster in mapbox's
              <a href="https://docs.mapbox.com/data/tilesets/reference/mapbox-terrain-dem-v1/" target="_blank">terrain encoded format</a>.
              As mentioned in our
              <a href="https://digital.ebp.ch/2023/10/09/cloudnative-geospatial-diy-hoehenlinien-aus-der-cloud-teil-2/" target="_blank"
                >blog series about DIY contours</a
              >, this can be easily done using <a href="https://rasterio.readthedocs.io/en/stable/" target="_blank"><code>rasterio</code></a
              >. The following steps are required:
            </p>
            <pre><code class="language-bash"># set nodata values to 0, since the source dataset has unsupported nodata values
gdalwarp output_3857.tif output_3857_nodata.tif -dstnodata 0 -of COG -co COMPRESS=LZW -co BIGTIFF=YES

# create terrain encoded raster
uv run rio rgbify -b -10000 -i 0.1 output_3857_nodata.tif output_rgb.tif

# create a cogtiff from the terrain encoded raster
uv run rio cogeo create output_rgb.tif output_rgb_cog_rio.tif</code></pre>
            <p>
              There are plenty of ways to install <code>rasterio</code>, but in the above, we simply created a new python project using
              <a href="https://docs.astral.sh/uv/" target="_blank"><code>uv</code></a> and added the required dependencies. Doing so allows
              us to run <code>rasterio</code> commands as simple python modules. The last step is very important, because if we create the
              COGTIFF from the RGB encoded terrain directly using <code>gdal_translate</code>, we'll get artifacts on the more generalized
              tiles, because the rounding between the raster values is not a simple interpolation.
              <a href="https://github.com/cogeotiff/rio-cogeo" target="_blank"><code>rasterio-cogeo</code></a>
              takes care of this. If you toggle the raster overlay using the button above, you can see what the encoding looks like.
            </p>
            <p>
              Last but not least, we <i>could</i> use the elevation query on the terrain layer directly, but because we're using a COGTIFF,
              there are instances where a given Pixel does not have the correct elevation information or has not yet been loaded. Therefore,
              we directly query the raster at the given pixel value and decode the RGB-encoded information into the original elevation
              value.
            </p>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
